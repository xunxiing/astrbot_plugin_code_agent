
# AstrBot 编程智能体插件 (Code Agent)

这是一个为 [AstrBot](https://github.com/AstrBotDevs/AstrBot) 设计的强大插件，它在机器人内部集成了一个能够理解自然语言、编写并执行代码的编程智能体。

本插件基于优秀的开源项目 https://github.com/huggingface/smolagents.git 构建，并通过一个特制的“桥接器”，使其能够完全利用您在 AstrBot 中已经配置好的任何大语言模型（如 OpenAI, Gemini, Ollama, Groq 等）。

---

🚨 **严重安全警告** 🚨
---

**在使用前请务必阅读：**

本插件的核心功能是**直接在运行 AstrBot 的服务器上执行由大语言模型生成的 Python 代码**。这带来了极大的灵活性，但同时也伴随着**严重的安全风险**，包括但不限于：

*   **文件系统访问**：AI 可能生成读取、写入、修改甚至删除您服务器上任何文件的代码。
*   **执行任意系统命令**：AI 可能生成执行 `os.system()` 等危险命令的代码，对您的系统造成破坏。
*   **网络请求**：AI 可能生成代码来访问外部或内部网络，可能导致数据泄露。

**因此，您必须：**
1.  **仅在完全受信任的环境中**安装和使用本插件。
2.  **绝不将此插件暴露给不受信任的用户**或在公开的、非私人的群聊中使用。
3.  使用者需要对可能产生的任何后果负全部责任。

---

## ✨ 主要特性

*   **自然语言编程**：用日常语言描述您的需求，智能体将自动编写 Python 代码来实现它。
*   **无缝集成**：完美利用您在 AstrBot 中已配置好的大语言模型，无需为插件单独配置 API Key。
*   **具备联网能力**：内置网页搜索工具 (`WebSearchTool`)，智能体在遇到不确定的问题时可以自行上网搜索信息。
*   **成品交付**：任务完成后，插件会自动将生成的代码打包成 `.zip` 压缩文件发送给您，方便下载和使用。
*   **轻量化设计**：插件本身非常轻量，仅负责逻辑调度，最消耗资源的模型计算由您配置的 LLM 提供商完成。
*   **可配置**：您可以自定义智能体的最大执行步骤，防止任务陷入死循环。

## ⚙️ 安装指南

1.  **下载插件**:
    *   访问本仓库页面，点击绿色的 `Code` 按钮，然后选择 `Download ZIP`。
    *   解压下载的文件，您会得到一个名为 `astrabot_plugin_code_agent-main` (或类似) 的文件夹。
2.  **放置插件**:
    *   将解压后的文件夹重命名为 `astrabot_plugin_code_agent`。
    *   将这个文件夹完整地移动到您的 AstrBot 项目的 `data/plugins/` 目录下。
3.  **重启 AstrBot**:
    *   **彻底关闭并重新启动** AstrBot。
    *   在启动过程中，AstrBot 会自动检测到新插件，并根据 `requirements.txt` 文件安装所有必需的依赖库。

## 🚀 使用方法

通过发送指令来激活编程智能体。指令支持别名 `ca` 或 `编程`。

**指令格式**:
```
/code_agent <你的编程任务>
```

**使用示例**:

*   **简单的任务**:
    ```
    /ca 写一个输出 "Hello, AstrBot!" 的 python 程序
    ```
*   **需要计算的任务**:
    ```
    /编程 计算斐波那契数列的前30项，并打印出来
    ```
*   **需要联网搜索的任务**:
    ```
    /code_agent 使用 python 写一个函数，获取特斯拉和苹果公司当前的股票价格
    ```
*   **生成文件**:
    ```
    /ca 帮我写一个简单的个人介绍网页的 html 代码
    ```

智能体在收到任务后会开始思考和执行，并在完成后将包含代码的 `.zip` 文件发送给您。

## 🛠️ 配置选项

您可以在 AstrBot 的 `管理面板` -> `插件管理` -> `编程智能体` 的设置页面中找到以下配置项：

*   **`max_iterations`** (最大迭代次数):
    *   **描述**: 智能体为了完成一个任务最多可以执行的步骤（思考->执行代码）次数。
    *   **作用**: 防止 AI 陷入死循环或执行时间过长。
    *   **默认值**: `7`

## 💡 工作原理

1.  用户通过 `/code_agent` 指令发送任务。
2.  插件激活，并将任务交给内部打包的 `smol-agents` 的 `CodeAgent`。
3.  插件中的 `AstrBotLLMBridge` 模块作为“翻译官”，负责将 `CodeAgent` 的思考请求发送给 AstrBot 的 LLM 提供商。
4.  `CodeAgent` 根据 LLM 的返回结果，生成 Python 代码并使用其内置的工具（如 `WebSearchTool`）。
5.  代码在非沙箱环境中执行。
6.  当任务完成时，`CodeAgent` 调用 `final_answer()` 工具，插件捕获其结果。
7.  插件将最终的代码字符串写入 `.py` 文件，打包成 `.zip`，然后发送给用户。

## ❤️ 反馈与贡献

如果您在使用过程中遇到任何问题、有好的建议，或者发现了 Bug，欢迎在本仓库的 [Issues](https://github.com/YourUsername/astrabot_plugin_code_agent/issues) 页面提出！

同样欢迎您通过 Pull Request 为本插件贡献代码。

---
```

